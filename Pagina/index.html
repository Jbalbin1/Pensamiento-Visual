<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prototipo ‚Äî Visualizaci√≥n de datos</title>
  <link rel="stylesheet" href="css/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
</head>

<body>
  <!-- Header compartido -->
  <div id="header-placeholder"></div>
  <script>
    fetch("header.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("header-placeholder").innerHTML = html;

        // === Scroll-spy: resalta el bot√≥n seg√∫n secci√≥n visible ===
        const sections = [
          document.getElementById("inicio"),
          document.getElementById("stats"),
          document.getElementById("motivacion"),
        ].filter(Boolean);

        const linkMap = new Map();
        // Mapea href -> <a>
        document.querySelectorAll('.topbar .nav .btn').forEach(a => {
          const hash = (a.getAttribute('href') || '').split('#')[1];
          if (hash && document.getElementById(hash)) linkMap.set(hash, a);
        });

        const setActive = (id) => {
          document.querySelectorAll('.topbar .nav .btn').forEach(a => a.classList.remove('is-active'));
          const btn = linkMap.get(id);
          if (btn) btn.classList.add('is-active');
        };

        // Observa qu√© secci√≥n est√° en viewport
        const obs = new IntersectionObserver((entries) => {
          // ordena por intersecci√≥n y escoge la m√°s visible
          const visible = entries
            .filter(e => e.isIntersecting)
            .sort((a, b) => b.intersectionRatio - a.intersectionRatio)[0];
          if (visible) setActive(visible.target.id);
        }, { rootMargin: '-20% 0px -60% 0px', threshold: [0.25, 0.6, 0.9] });

        sections.forEach(sec => obs.observe(sec));

        // Al hacer click, marcar al tiro (mejor UX)
        document.querySelectorAll('.topbar .nav .btn[href*="#"]').forEach(a => {
          a.addEventListener('click', () => {
            const id = a.getAttribute('href').split('#')[1];
            if (id) setActive(id);
          });
        });
      });
  </script>

  <section id="inicio" class="section hero hero-v3">
    <div class="hero-bg">
      <img src="img/calle-nocturna-chile.jpg" alt="Calle chilena de noche, una ventana prendida">
      <div class="hero-overlay"></div>
    </div>

    <div class="hero-content">
      <div class="hero-layer layer1">
        <h1>
          Explora,<br>
          cuestionate,<br>
          Conversa.<br>
          <span class="highlight">Informarte es ayudar.</span>
        </h1>
      </div>

      <div class="hero-layer layer2">
        <p>Muchos percibimos los problemas sociales como algo ajeno o inevitable,<br>
          pero el cambio <strong>est√° en cada uno</strong>.</p>
      </div>

      <div class="hero-layer layer3">
        <p>Queremos que entiendas, te cuestiones y converses
          para as√≠ tener una ciudadan√≠a <strong>m√°s consciente y emp√°tica</strong>.</p>
      </div>

      <div class="hero-layer layer4">
        <h2>
          <strong>¬øQu√© es la satisfacci√≥n de la vida?</strong><br>
        </h2>
        <p>Es c√≥mo <strong>cada uno</strong> valora su existencia <strong>en el momento</strong>,
          mirando la <br>
          <strong>salud, seguridad, felicidad</strong>.
        </p>
      </div>
    </div>
  </section>

  <div id="DelitosVIFSatisfacci√≥n">
    <h1>Delitos, Violencia Intra Familiar y Satisfacci√≥n:</h1>
    <div class="controls">
      <label for="yearSel"></label>
      <select id="yearSel"></select>
    </div>
  </div>
  <main class="grid" id="stats">


    <section class="panel">
      <div id="MapaRegion">
        <h2>Mapa por satisfacci√≥n</h2>
      </div>

      <!-- MODO √öNICO (1 mapa) -->
      <div class="stage" id="singleStage">
        <svg id="mapSvg" viewBox="0 0 700 1000" preserveAspectRatio="xMidYMid meet">
          <g id="mapGroup"></g>
        </svg>
        <!-- Mensaje fijo al lado del mapa -->
        <div id="helpMessage" class="help-message">
          üëÜ Haz clic en alguna regi√≥n para acceder a m√°s informaci√≥n
        </div>
      </div>

      <!-- MODO COMPARAR (2 mapas) -->
      <div class="stage stage-compare" id="compareStage" hidden>
        <div class="compare-pane">
          <div class="map-subtitle" id="labelLeft">2021</div>
          <svg id="mapSvgL" viewBox="0 0 700 1000" preserveAspectRatio="xMidYMid meet">
            <g id="mapGroupL"></g>
          </svg>
        </div>
        <div class="compare-pane">
          <div class="map-subtitle" id="labelRight">2023</div>
          <svg id="mapSvgR" viewBox="0 0 700 1000" preserveAspectRatio="xMidYMid meet">
            <g id="mapGroupR"></g>
          </svg>
        </div>
      </div>
    </section>


    <section class="panel panel-detail">
      <div id="detailBox" class="detail-box" hidden>
        <h1 id="detailTitle">Regi√≥n</h1>

        <!-- --- NUEVO: Mostrar el a√±o --- -->
        <div id="detailYear" class="detail-year">Datos de: ...</div>
        <!-- --- FIN NUEVO --- -->

        <!-- regi√≥n duplicada (m√°s peque√±a) -->
        <svg id="detailRegionSvg" width="220" height="140"></svg>

        <!-- KPIs principales -->
        <div class="kpi-row">
          <div class="kpi">
            <div class="icon">üòä</div>
            <div class="value" id="satValue">‚Äî</div>
            <div class="sub">Satisfacci√≥n</div>
            <div class="rank" id="satRank">‚Äî</div>
            <!-- --- CORREGIDO: Eliminado texto descriptivo de aqu√≠ --- -->
            <div class="description">Porcentaje de la poblaci√≥n satisfecha con sus vidas.</div>

          </div>
          <div class="kpi">
            <div class="icon">üè†</div>
            <div class="value" id="vifValue">‚Äî</div>
            <div class="sub">Porcentaje de casas que sufren de violencia intrafamiliar</div>
            <div class="rank" id="vifRank">‚Äî</div>
            <!-- --- NUEVO: Texto descriptivo para VIF --- -->
            <div class="description">Tasa de la poblaci√≥n afectada por Violencia Intrafamiliar.</div>
            <!-- --- FIN NUEVO --- -->
          </div>
          <div class="kpi">
            <div class="icon">üîó</div>
            <div class="value" id="delValue">‚Äî</div>
            <div class="sub">Personas que sufren delitos de tipo menor </div>
            <div class="rank" id="delRank">‚Äî</div>
            <!-- --- NUEVO: Texto descriptivo para Delitos --- -->
            <div class="description">Tasa de la poblaci√≥n afectada por delitos.</div>
            <!-- --- FIN NUEVO --- -->
          </div>
        </div>

        <!-- 2 tarjetas: VIF desglosado y delitos estudiados -->
        <div class="cards-2">
          <div class="card">
            <h4>Violencia intrafamiliar</h4>
            <!-- --- NUEVO: Contenedor para el gr√°fico y la leyenda --- -->
            <div class="vif-container">
              <!-- Leyenda a la izquierda -->
              <div id="vifLegend" class="vif-legend"></div>
              <!-- Gr√°fico de torta a la derecha -->
              <svg id="vifPieChart" width="180" height="180"></svg>
            </div>
            <!-- --- FIN NUEVO --- -->
          </div>

          <div class="card">
            <h4>Delitos de tipo menor</h4>
            <ul id="delitosList" class="bullets"></ul>
          </div>
        </div>

        <!-- --- MODIFICADO: Bot√≥n de cerrar m√°s grande --- -->
        <button id="closeDetail" class="close-detail large-button">Cerrar</button>
        <!-- --- FIN MODIFICADO --- -->
      </div>
    </section>

    <!-- === PANEL BURBUJAS POR REGI√ìN (NUEVO) === -->
    <section class="panel panel-bubbles">
      <div id="BurbujasGrilla">
        <h2>Burbujas por regi√≥n</h2>
      </div>

      <!-- El JS busca este ID -->
      <div class="stage">
        <svg id="gridSvg" viewBox="0 0 1200 700" preserveAspectRatio="xMidYMid meet"></svg>
      </div>

      <!-- Recuadro de detalle opcional (si lo usas para burbujas) -->
      <!-- Por ahora, solo dejamos el panel principal y el SVG. -->
    </section>

  </main>

  <section id="motivacion" class="section motivation">
    <div class="container">
      <h2>¬øQu√© puedo hacer como individuo?</h2>

      <div class="tips tips-big">
        <div class="tip">
          <h3>1) Habla del tema</h3>
          <p>Conversar de de la Violencia Intra Familiar y delitos <strong>rompe el silencio</strong> y ayuda a ver
            se√±ales a tiempo.</p>
        </div>
        <div class="tip">
          <h3>2) Arma red</h3>
          <p>Escucha sin juzgar, comparte informaci√≥n de ayuda y acompa√±a. <strong>No est√°s sol@.</strong></p>
        </div>
        <div class="tip">
          <h3>3) Participa</h3>
          <p>Centro de estudiantes, juntas, campa√±as locales. <strong>Peque√±as acciones = grandes cambios.</strong></p>
        </div>
        <div class="tip">
          <h3>4) Respeto siempre</h3>
          <p>L√≠mites sanos, empat√≠a, cero tolerancia a la violencia. <strong>Parte por tu c√≠rculo.</strong></p>
        </div>
        <div class="tip">
          <h3>5) Denuncia responsable</h3>
          <p>Si hay riesgo, <strong>busca apoyo adulto</strong>, autoridades o l√≠neas de ayuda.</p>
        </div>
      </div>

      <div class="cta-row">
        <p class="cta-text">La informaci√≥n es poder cuando se vuelve <strong>acci√≥n</strong>.</p>
      </div>
    </div>
  </section>

  <script src="js/bubbles.js"></script>
  <script src="js/map.js"></script>
  <script src="js/main.js"></script>
  <script src="js/burbujas.js"></script>

</body>

</html>